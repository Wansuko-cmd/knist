name: 'TinyStoriesモデルの出力を確認'

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ${{ matrix.os.image }}
    name: Build (${{ matrix.os.name }}/${{ matrix.os.arch }})/${{ matrix.index }}
    strategy:
      fail-fast: false
      matrix:
        index: [ 0, 1, 2, 3, 4 ]
        os:
          # macOS
          - image: macos-latest
            name: macos
            arch: Arm64
          # Linux
          - image: ubuntu-latest
            name: linux
            arch: X64
          - image: ubuntu-24.04-arm
            name: linux
            arch: Arm64
          # Windows
          - image: windows-latest
            name: windows
            arch: X64
    steps:
      - name: リポジトリにチェックアウト
        uses: actions/checkout@v4

      - name: Javaのセットアップ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
          cache: 'gradle'

      - name: OpenMPのセットアップ（macOS）
        if: runner.os == 'macOS'
        run: |
          brew install libomp

      - name: TinyStoriesデータセットのキャッシュを復元
        id: cache-tiny-stories
        uses: actions/cache@v4
        with:
          path: sample/src/main/resources/stories
          key: tiny-stories-dataset-v1

      - name: TinyStoriesデータセットをダウンロード
        if: steps.cache-tiny-stories.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p sample/src/main/resources/stories
          echo "TinyStories-train.txtをダウンロード中..."
          curl -L -o "sample/src/main/resources/stories/TinyStories-train.txt" "https://huggingface.co/datasets/roneneldan/TinyStories/resolve/main/TinyStories-train.txt"
          echo "TinyStories-valid.txtをダウンロード中..."
          curl -L -o "sample/src/main/resources/stories/TinyStories-valid.txt" "https://huggingface.co/datasets/roneneldan/TinyStories/resolve/main/TinyStories-valid.txt"
          echo "ダウンロード完了"

      - name: gradlewに権限を付与 (Unix)
        if: runner.os != 'Windows'
        run: chmod 777 ${{ github.workspace }}/gradlew

      - name: TinyStoriesテストを実行（macOS以外）
        if: runner.os != 'macOS'
        shell: bash
        run: |
          ./gradlew sample:test --tests "stories.TinyStoriesTest" --info --no-build-cache

      - name: TinyStoriesテストを実行（macOS）
        if: runner.os == 'macOS'
        shell: bash
        run: |
          export OpenMP_ROOT=$(brew --prefix)/opt/libomp
          ./gradlew sample:test --tests "stories.TinyStoriesTest" --info --no-build-cache
